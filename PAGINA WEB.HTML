<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Tracking en Tiempo Real</title>

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin: 0; }
    #map { width: 100%; height: 100vh; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="status" style="position:absolute; top:10px; left:10px; background:white; padding:10px; z-index:1000; border-radius:5px;"></div>

<script>

const supabaseUrl = "https://zmviygufhryjnszbcujj.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inptdml5Z3VmaHJ5am5zemJjdWpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MDExNTcsImV4cCI6MjA4Njk3NzE1N30.TdWImk6rqDgfutJn5I5RQ5gzLQstf205ZB9nugu8GKE";

const statusDiv = document.getElementById('status');
statusDiv.innerHTML = "Inicializando...";

let supabaseClient;

try {
  if (typeof supabase === 'undefined') {
    statusDiv.innerHTML = "Error: Supabase no está cargado";
  } else {
    supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    statusDiv.innerHTML += "<br>Supabase conectado";
  }
} catch (e) {
  statusDiv.innerHTML = "Error al conectar Supabase: " + e.message;
}

mapboxgl.accessToken = "pk.eyJ1IjoianVhbnNpcnBhIiwiYSI6ImNtbHB6ZzZiMDA5cmszaG9yN2g2bWk4bjQifQ.67BmhX6Fdql2qNvg7Yq0SQ";

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v11',
  center: [-66.1568, -17.3895],
  zoom: 14
});

map.on('load', () => {
  statusDiv.innerHTML += "<br>Mapa cargado ✓";
});

map.on('error', (e) => {
  statusDiv.innerHTML += "<br>Error mapa: " + e.error.message;
});

let marker;

async function cargarUltimaUbicacion() {
  if (!supabaseClient) {
    statusDiv.innerHTML += "<br>Error: Sin cliente Supabase";
    return;
  }
  
  statusDiv.innerHTML += "<br>Cargando ubicación...";
  
  try {
    const { data, error } = await supabaseClient
      .from('locations')
      .select('*')
      .order('id', { ascending: false })
      .limit(1);

    if (error) {
      statusDiv.innerHTML += "<br>Error Supabase: " + error.message;
      return;
    }

    if (data && data.length > 0) {
      statusDiv.innerHTML += "<br>Ubicacion: " + data[0].latitude + ", " + data[0].longitude;
      actualizarMapa(data[0].latitude, data[0].longitude);
    } else {
      statusDiv.innerHTML += "<br>Sin ubicaciones";
    }
  } catch (e) {
    statusDiv.innerHTML += "<br>Error: " + e.message;
  }
}

function actualizarMapa(lat, lng) {
  if (marker) {
    marker.setLngLat([lng, lat]);
  } else {
    marker = new mapboxgl.Marker().setLngLat([lng, lat]).addTo(map);
  }
  map.flyTo({ center: [lng, lat], speed: 1.2 });
}

if (supabaseClient) {
  supabaseClient
    .channel('realtime-locations')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'locations' },
      payload => {
        statusDiv.innerHTML += "<br>Nueva ubicacion";
        actualizarMapa(payload.new.latitude, payload.new.longitude);
      }
    )
    .subscribe((status) => {
      statusDiv.innerHTML += "<br>Realtime: " + status;
    });
}

cargarUltimaUbicacion();

</script>

</body>
</html>